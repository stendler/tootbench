---
- name: Start monitoring
  hosts: all
  become: yes
  tasks:
    - name: Start vmstat monitoring service
      systemd:
        name: vmstat.service
        state: started
    - name: Start iostat cpu monitoring service
      systemd:
        name: iostat-cpu.service
        state: started
    - name: Start iostat disk monitoring service
      systemd:
        name: iostat-disk.service
        state: started
    - name: Start mpstat monitoring service
      systemd:
        name: mpstat.service
        state: started
    - name: Start ping monitoring services
      systemd:
        name: "ping@{{ item }}.service"
        state: started
      loop: "{{ ansible_play_batch|difference(inventory_hostname) }}"
    - name: Start docker stats monitoring service
      systemd:
        name: docker-stats.service
        state: started

- name: Start Mastodon
  hosts: instances
  tasks:
    - name: Wait to collect idle system metrics
      pause:
        minutes: "1"
    - name: Start mastodon containers
      command:
        chdir: /home/ansible
        cmd: docker compose --project-name mastodon up --wait
      environment:
        hostname: "{{ hostname }}"
        MASTODON_VERSION: "{{ mastodon_version }}"
    - name: Wait to collect container startup metrics
      pause:
        minutes: "1"

- name: Start Benchmark
  hosts: clients
  become: yes
  tasks:
    - name: Start tootbench client
      systemd:
        name: tootbench.service
        state: started
